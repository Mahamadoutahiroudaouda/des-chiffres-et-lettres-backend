<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìä Admin - Des Chiffres & Lettres</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      font-family: 'Poppins', sans-serif;
    }
    .btn-refresh {
      background: linear-gradient(45deg, #2a9d8f, #264653);
      color: white;
    }
    .btn-refresh:hover {
      opacity: 0.9;
    }
    .badge {
      font-size: 0.8em;
      padding: 2px 8px;
      border-radius: 12px;
      margin: 2px;
    }
    .green { background: #2e7d32; color: white; }
    .red { background: #c62828; color: white; }
    .yellow { background: #f57f17; color: white; }
    .gray { background: #555; color: white; }
  </style>
</head>
<body class="text-white p-6">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold mb-2 flex items-center gap-3">
      <i class="fas fa-trophy text-yellow-400"></i>
      Tableau de Bord Admin üèÜ
    </h1>
    <p class="text-gray-300 mb-6">Classement des joueurs - <span id="currentDate"></span></p>

    <div class="bg-red-900 text-yellow-200 p-3 rounded mb-6 hidden" id="errorBox">
      <i class="fas fa-exclamation-triangle"></i> <span id="errorText"></span>
    </div>

    <button onclick="loadResults()" class="btn-refresh px-6 py-3 rounded-lg flex items-center gap-2 mb-8">
      <i class="fas fa-sync"></i> Actualiser les r√©sultats
    </button>

    <div id="resultsContainer">
      <p class="text-gray-500">Chargement des r√©sultats...</p>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const pwd = params.get('pwd');
    const API_URL = '/results?pwd=' + encodeURIComponent(pwd);

    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // Liste de mots valides (en MAJ, sans accents)
    const validWords = new Set([
      'ECOLE', 'ELEVE', 'MAISON', 'CHAT', 'CHIEN', 'LIVRE', 'TABLE', 'STYLO', 'PORTE', 'FENETRE',
      'ARBRE', 'FLEUR', 'PLANTE', 'SOLEIL', 'LUNE', 'ETOILE', 'CIEL', 'MER', 'MONTAGNE', 'RIVIERE',
      'ROUTE', 'VOITURE', 'TRAIN', 'AVION', 'VELO', 'MOTO', 'BATEAU', 'CAMION', 'BUS', 'METRO',
      'PAYSAGE', 'FORET', 'OISEAU', 'POISSON', 'INSECTE', 'ANIMAL', 'PLAGE', 'SABLE', 'VILLAGE'
    ]);

    // Normalise un mot (supprime accents, met en majuscule)
    function normalizeWord(word) {
      return word
        .toUpperCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    // Valide un mot
    function isValidWord(word) {
      const clean = normalizeWord(word.trim());
      if (clean.length < 2) return false;
      if (/[0-9]/.test(clean)) return false;
      if (clean.includes(' ') || clean.includes('-') || clean.includes('\'')) return false;
      return validWords.has(clean);
    }

    // Calcule les points pour les chiffres
    function calculateChiffresPoints(target, answer) {
      if (!answer || isNaN(answer)) return { points: 0, status: '‚ùå' };
      
      const diff = Math.abs(target - answer);
      if (diff === 0) return { points: 10, status: 'üéØ 10pts' };
      if (diff === 1) return { points: 7, status: 'üü® 7pts' };
      if (diff === 2) return { points: 6, status: 'üü® 6pts' };
      if (diff === 3) return { points: 5, status: 'üü® 5pts' };
      if (diff <= 7) return { points: 8 - diff, status: `üü® ${8 - diff}pts` };
      return { points: 0, status: '‚ùå 0pt' };
    }

    // Calcule les points pour les lettres
    function calculateLettresPoints(word) {
      if (!word || word.trim().length < 2) return { points: 0, status: '‚ùå 0pt' };
      
      const clean = normalizeWord(word);
      if (isValidWord(word)) {
        return { points: clean.length, status: `‚úÖ ${clean.length}pt${clean.length > 1 ? 's' : ''}` };
      }
      return { points: 0, status: '‚ùå 0pt' };
    }

    function loadResults() {
      fetch(API_URL)
        .then(r => r.json())
        .then(data => {
          const container = document.getElementById('resultsContainer');
          const errorBox = document.getElementById('errorBox');
          errorBox.classList.add('hidden');

          if (data.error) {
            errorBox.textContent = data.error;
            errorBox.classList.remove('hidden');
            container.innerHTML = '';
            return;
          }

          if (data.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Aucun joueur n\'a encore jou√©.</p>';
            return;
          }

          // Calcul des scores
          const players = data.map(player => {
            const chiffresScores = player.chiffres.map((answer, i) => {
              const round = player.chiffresRounds ? player.chiffresRounds[i] : { target: '???' };
              const target = round.target || 500;
              return calculateChiffresPoints(target, parseFloat(answer));
            });

            const lettresScores = player.lettres.map(word => {
              return calculateLettresPoints(word);
            });

            const totalChiffres = chiffresScores.reduce((a, b) => a + b.points, 0);
            const totalLettres = lettresScores.reduce((a, b) => a + b.points, 0);
            const total = totalChiffres + totalLettres;

            return { ...player, chiffresScores, lettresScores, totalChiffres, totalLettres, total };
          })
          .sort((a, b) => b.total - a.total);

          // G√©n√©ration du tableau
          container.innerHTML = `
            <div class="overflow-x-auto">
              <table class="w-full bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                <thead class="bg-gray-700">
                  <tr>
                    <th class="p-3 text-left">#</th>
                    <th class="p-3 text-left">Joueur</th>
                    <th class="p-3 text-center">Code</th>
                    <th class="p-3 text-center">Chiffres<br><span class="text-sm opacity-80">/100</span></th>
                    <th class="p-3 text-center">Lettres<br><span class="text-sm opacity-80">/??</span></th>
                    <th class="p-3 text-center font-bold">Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${players.map((p, i) => {
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                    return `
                    <tr class="border-t border-gray-700 ${i === 0 ? 'bg-yellow-900' : i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-750'}">
                      <td class="p-3 font-bold">${i+1} ${medal}</td>
                      <td class="p-3 font-semibold">${p.playerName}</td>
                      <td class="p-3 text-gray-300 text-sm">${p.code}</td>
                      <td class="p-3 text-center">
                        <span class="badge ${p.totalChiffres >= 80 ? 'green' : p.totalChiffres >= 50 ? 'yellow' : 'red'}">
                          ${p.totalChiffres}/100
                        </span>
                      </td>
                      <td class="p-3 text-center">
                        <span class="badge ${p.totalLettres >= 40 ? 'green' : p.totalLettres >= 20 ? 'yellow' : 'red'}">
                          ${p.totalLettres}
                        </span>
                      </td>
                      <td class="p-3 text-center font-bold text-lg">
                        ${p.total}
                      </td>
                    </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>

            <!-- D√©tails par joueur -->
            <div class="mt-10 space-y-8">
              <h2 class="text-2xl font-bold border-b border-gray-600 pb-2">D√©tails par joueur</h2>
              ${players.map(p => `
                <div class="bg-gray-800 p-5 rounded-lg">
                  <h3 class="text-xl font-bold mb-3">${p.playerName} <span class="text-sm opacity-70">(${p.code})</span></h3>
                  
                  <!-- Chiffres -->
                  <h4 class="font-semibold mb-2">üî¢ √âpreuve des chiffres</h4>
                  <div class="flex flex-wrap gap-2 mb-4">
                    ${p.chiffresScores.map((score, i) => `
                      <span class="badge ${score.points > 0 ? 'green' : 'red'}" title="Coup ${i+1}">
                        ${i+1}: ${score.status}
                      </span>
                    `).join('')}
                  </div>

                  <!-- Lettres -->
                  <h4 class="font-semibold mb-2">üî§ √âpreuve des lettres</h4>
                  <div class="flex flex-wrap gap-2">
                    ${p.lettres.map((word, i) => {
                      const clean = normalizeWord(word);
                      const valid = isValidWord(word);
                      return `
                      <span class="word-suggestion ${valid ? 'bg-green-800' : 'bg-red-800'}" 
                            title="${valid ? 'Valide' : 'Invalide'}">
                        ${clean || '‚Äì'} 
                        (${valid ? clean.length + 'pt' + (clean.length > 1 ? 's' : '') : '0pt'})
                      </span>
                      `;
                    }).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        })
        .catch(err => {
          document.getElementById('errorBox').textContent = 'Erreur de chargement des r√©sultats';
          document.getElementById('errorBox').classList.remove('hidden');
        });
    }

    // Chargement auto
    loadResults();
  </script>
</body>
</html>